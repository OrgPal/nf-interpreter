name: Build ORGPAL_PALX

on:
  workflow_dispatch

jobs:
  build_ORGPALX:
    runs-on: windows-latest

    env:
      TARGET_NAME: 'ORGPAL_PALX'

    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0
        ref: 'orgpal-palx'

    - uses: seanmiddleditch/gha-setup-ninja@master

    - name: Install arm-none-eabi-gcc
      uses: carlosperate/arm-none-eabi-gcc-action@v1
      with:
        release: '12.2.Rel1'
        path-env-var: ARM_NONE_EABI_GCC_PATH

    - name: Tweak PATH to reach cmd
      run: echo "C:\Windows\System32" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

    - name: Install hex2dfu
      run: ./install-scripts/install-nf-hex2dfu.ps1

    - name: Adjust HexDFU path
      run: |
        $hex2dfuPath = "$env:RUNNER_TEMP".Replace('\','/') + "/hex2dfu"
        echo "HEX2DFU_PATH=$hex2dfuPath" | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf-8 -Append

    - name: Set version
      run: nbgv cloud -a -c

    - name: Compose CMakeUserPresets
      run: |
        $file = "CMakeUserPresets.json"

        Rename-Item -Path "CMakeUserPresets.TEMPLATE.json" -NewName $file
        
        $filecontent = Get-Content($file)
        attrib $file -r
        $filecontent -replace  'Debug', 'MinSizeRel' | Out-File $file -Encoding UTF8

        [regex]$pattern='user-local-tools'
        $pattern.replace([IO.File]::ReadAllText($file), 'user-local-tools-dummy', 1) | Out-File $file -Encoding UTF8

        $filecontent = Get-Content($file)
        $filecontent -replace  'user-local-tools-cloud', 'user-local-tools' | Out-File $file -Encoding UTF8

    - name: Build with CMake
      run: |
        cmake -B build --preset ${{ env.TARGET_NAME }} -DCMAKE_BUILD_TYPE=MinSizeRel -DBUILD_VERSION='${{env.NBGV_VersionMajor}}.${{env.NBGV_VersionMinor}}.${{env.NBGV_BuildNumber}}.${{env.NBGV_VersionHeight}}' -DTARGET_BOARD=${{ env.TARGET_NAME }} -DTARGET_NAME=${{ env.TARGET_NAME }} -DTOOL_HEX2DFU_PREFIX=${{ env.HEX2DFU_PATH }}
        cmake --build ${{ github.workspace }}/build --target all
      working-directory: ${{ github.workspace }}

    - uses: actions/upload-artifact@v2
      with:
        name: '${{ env.TARGET_NAME }}-v${{env.NBGV_VersionMajor}}.${{env.NBGV_VersionMinor}}.${{env.NBGV_BuildNumber}}.${{env.NBGV_VersionHeight}}'
        path: |
          ${{ github.workspace }}/build/*.bin
          ${{ github.workspace }}/build/*.hex
          ${{ github.workspace }}/build/*.dfu

  build_ORGPALX_CHIBIOS:
    runs-on: windows-latest

    env:
      TARGET_NAME: 'ORGPAL_PALX_CHIBIOS'

    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0
        ref: 'orgpal-palx'

    - uses: seanmiddleditch/gha-setup-ninja@master

    - name: Install arm-none-eabi-gcc
      uses: carlosperate/arm-none-eabi-gcc-action@v1
      with:
        release: '11.3.Rel1'
        path-env-var: ARM_NONE_EABI_GCC_PATH

    - name: Tweak PATH to reach cmd
      run: echo "C:\Windows\System32" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

    - name: Install hex2dfu
      run: ./install-scripts/install-nf-hex2dfu.ps1

    - name: Adjust HexDFU path
      run: |
        $hex2dfuPath = "$env:RUNNER_TEMP".Replace('\','/') + "/hex2dfu"
        echo "HEX2DFU_PATH=$hex2dfuPath" | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf-8 -Append

    - name: Set version
      run: nbgv cloud -a -c

    - name: Compose CMakeUserPresets
      run: |
        $file = "CMakeUserPresets.json"

        Rename-Item -Path "CMakeUserPresets.TEMPLATE.json" -NewName $file
        
        [regex]$pattern='user-local-tools'
        $pattern.replace([IO.File]::ReadAllText($file), 'user-local-tools-dummy', 1) | Out-File $file -Encoding UTF8

        $filecontent = Get-Content($file)
        $filecontent -replace  'user-local-tools-cloud', 'user-local-tools' | Out-File $file -Encoding UTF8

    - name: Build with CMake
      run: |
        cmake -B build --preset ${{ env.TARGET_NAME }} -DCMAKE_BUILD_TYPE=Debug -DBUILD_VERSION='${{env.NBGV_VersionMajor}}.${{env.NBGV_VersionMinor}}.${{env.NBGV_BuildNumber}}.${{env.NBGV_VersionHeight}}' -DTOOL_HEX2DFU_PREFIX=${{ env.HEX2DFU_PATH }}
        cmake --build ${{ github.workspace }}/build --target all
      working-directory: ${{ github.workspace }}

    - uses: actions/upload-artifact@v2
      with:
        name: '${{ env.TARGET_NAME }}-v${{env.NBGV_VersionMajor}}.${{env.NBGV_VersionMinor}}.${{env.NBGV_BuildNumber}}.${{env.NBGV_VersionHeight}}'
        path: |
          ${{ github.workspace }}/build/*.bin
          ${{ github.workspace }}/build/*.hex
          ${{ github.workspace }}/build/*.dfu
