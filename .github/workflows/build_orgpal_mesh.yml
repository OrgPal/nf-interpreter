name: Build ORGPAL_MESH

on:
  workflow_dispatch

jobs:
  build_ORGPAL_MESH_NODE:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0
        ref: 'orgpal-mesh'

    - uses: seanmiddleditch/gha-setup-ninja@master

    - name: Install arm-none-eabi-gcc
      uses: carlosperate/arm-none-eabi-gcc-action@v1
      with:
        release: '10.3-2021.10'
        path-env-var: ARM_NONE_EABI_GCC_PATH

    - name: Tweak GCC path
      run: |
        $currentPath = "$env:ARM_NONE_EABI_GCC_PATH"
        if($currentPath.EndsWith("bin"))
        {
          $fixedPath = $currentPath.Replace("\bin", "")
          
          echo "ARM_NONE_EABI_GCC_PATH=$fixedPath" | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf-8 -Append
        }

    - run: nbgv cloud -a -c

    - uses: urkle/action-cmake-build@v1
      with:
        build-dir: ${{ runner.workspace }}/build
        build-type: MinSizeRel
        configure-options: >-
          -G Ninja
          -DCMAKE_TOOLCHAIN_FILE=CMake/toolchain.arm-none-eabi.cmake
          -DTOOLCHAIN_PREFIX='${{env.ARM_NONE_EABI_GCC_PATH}}'
          -DCMAKE_BUILD_TYPE='MinSizeRel'
          -DBUILD_VERSION=${{env.NBGV_VersionMajor}}.${{env.NBGV_VersionMinor}}.${{env.NBGV_BuildNumber}}.${{env.NBGV_VersionHeight}}
          -DTARGET_BOARD=ORGPAL_MESH_NODE
          -DTARGET_NAME=ORGPAL_MESH_NODE
          -DTARGET_SERIES=CC13X2
          -DRTOS=TI_SimpleLink
          -DRADIO_FREQUENCY=915
          -DSUPPORT_ANY_BASE_CONVERSION=OFF
          -DNF_TARGET_HAS_NANOBOOTER=OFF
          -DNF_FEATURE_SUPPORT_REFLECTION=OFF
          -DNF_FEATURE_DEBUGGER=ON
          -DNF_FEATURE_RTC=ON
          -DNF_PLATFORM_NO_CLR_TRACE=ON
          -DNF_CLR_NO_IL_INLINE=ON
          -DNF_FEATURE_WATCHDOG=OFF
          -DAPI_System.Device.Gpio=ON
          -DAPI_System.IO.Ports=ON
          -DAPI_System.Device.Adc=ON
          -DAPI_System.Math=OFF
          -DAPI_nanoFramework.TI.EasyLink=ON
          -DAPI_nanoFramework.Hardware.TI=ON
          -DAPI_nanoFramework.System.Text=ON
        run-test: false
        parallel: 14

    - uses: actions/upload-artifact@v2
      with:
        name: 'ORGPAL_MESH_NODE-v${{env.NBGV_VersionMajor}}.${{env.NBGV_VersionMinor}}.${{env.NBGV_BuildNumber}}.${{env.NBGV_VersionHeight}}'
        path: |
          ${{ runner.workspace }}/build/*.bin
          ${{ runner.workspace }}/build/*.hex

  build_ORGPAL_MESH_HUB:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0
        ref: 'orgpal-mesh'

    - uses: seanmiddleditch/gha-setup-ninja@master

    - name: Install arm-none-eabi-gcc
      uses: carlosperate/arm-none-eabi-gcc-action@v1
      with:
        release: '10.3-2021.10'
        path-env-var: ARM_NONE_EABI_GCC_PATH

    - name: Tweak GCC path
      run: |
        $currentPath = "$env:ARM_NONE_EABI_GCC_PATH"
        if($currentPath.EndsWith("bin"))
        {
          $fixedPath = $currentPath.Replace("\bin", "")
          
          echo "ARM_NONE_EABI_GCC_PATH=$fixedPath" | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf-8 -Append
        }

    - run: nbgv cloud -a -c

    - uses: urkle/action-cmake-build@v1
      with:
        build-dir: ${{ runner.workspace }}/build
        build-type: MinSizeRel
        configure-options: >-
          -G Ninja
          -DCMAKE_TOOLCHAIN_FILE=CMake/toolchain.arm-none-eabi.cmake
          -DTOOLCHAIN_PREFIX='${{env.ARM_NONE_EABI_GCC_PATH}}'
          -DCMAKE_BUILD_TYPE='MinSizeRel'
          -DBUILD_VERSION=${{env.NBGV_VersionMajor}}.${{env.NBGV_VersionMinor}}.${{env.NBGV_BuildNumber}}.${{env.NBGV_VersionHeight}}
          -DTARGET_BOARD=ORGPAL_MESH_HUB
          -DTARGET_NAME=ORGPAL_MESH_HUB
          -DTARGET_SERIES=CC13X2
          -DRTOS=TI_SimpleLink
          -DRADIO_FREQUENCY=915
          -DSUPPORT_ANY_BASE_CONVERSION=OFF
          -DNF_TARGET_HAS_NANOBOOTER=OFF
          -DNF_FEATURE_SUPPORT_REFLECTION=OFF
          -DNF_FEATURE_DEBUGGER=ON
          -DNF_FEATURE_RTC=ON
          -DNF_PLATFORM_NO_CLR_TRACE=ON
          -DNF_CLR_NO_IL_INLINE=ON
          -DNF_FEATURE_WATCHDOG=OFF
          -DAPI_System.Device.Gpio=ON
          -DAPI_System.IO.Ports=ON
          -DAPI_System.Math=OFF
          -DAPI_nanoFramework.TI.EasyLink=ON
          -DAPI_nanoFramework.Hardware.TI=ON
          -DAPI_nanoFramework.System.Text=ON
        run-test: false
        parallel: 14

    - uses: actions/upload-artifact@v2
      with:
        name: 'ORGPAL_MESH_HUB-v${{env.NBGV_VersionMajor}}.${{env.NBGV_VersionMinor}}.${{env.NBGV_BuildNumber}}.${{env.NBGV_VersionHeight}}'
        path: |
          ${{ runner.workspace }}/build/*.bin
          ${{ runner.workspace }}/build/*.hex
